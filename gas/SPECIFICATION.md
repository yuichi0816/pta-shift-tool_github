# PTA旗振りシフト リマインドメール送信スクリプト 仕様書

## 概要

Google Apps Script (GAS) を使用して、旗振り担当日の**前日20時**に保護者へリマインドメールを自動送信するシステム。

## システム構成

```
┌─────────────────────────────────────────────────────────────┐
│                    Googleスプレッドシート                      │
│  「旗振り担当日リマインドメール自動送信」                        │
├─────────────────────────────────────────────────────────────┤
│  シート1: アンケート回答                                       │
│    - B列: メールアドレス                                       │
│    - N列: 氏名                                                │
├─────────────────────────────────────────────────────────────┤
│  シート2: シフト結果                                          │
│    - A列: 日付                                                │
│    - B列: 曜日                                                │
│    - C列〜: 地点名（ヘッダー行）と担当者名                      │
├─────────────────────────────────────────────────────────────┤
│  シート3: 送信ログ（自動作成）                                  │
│    - 送信日時、対象日付、氏名、場所、メール、ステータス           │
├─────────────────────────────────────────────────────────────┤
│  同一フォルダ: 添付PDF                                         │
│    - ファイル名末尾が「旗振り地点について.pdf」のファイル          │
│    - 例: R7旗振り地点について.pdf, R8旗振り地点について.pdf       │
└─────────────────────────────────────────────────────────────┘
           ↓
    Google Apps Script (reminder_email.gs)
           ↓
    Gmail送信 + ラベル付け + アーカイブ
```

---

## 設定項目 (CONFIG)

| 項目 | デフォルト値 | 説明 |
|------|-------------|------|
| `SHIFT_SHEET_NAME` | `'シフト結果'` | シフト結果シートの名前 |
| `SURVEY_SHEET_NAME` | `'アンケート回答'` | アンケート回答シートの名前 |
| `LOG_SHEET_NAME` | `'送信ログ'` | 送信ログシートの名前（自動作成） |
| `SHIFT_DATE_COL` | `'A'` | シフト結果の日付列 |
| `SHIFT_LOCATION_START_COL` | `'C'` | 地点の開始列（終了は自動検出） |
| `SURVEY_EMAIL_COL` | `'B'` | アンケート回答のメールアドレス列 |
| `SURVEY_NAME_COL` | `'N'` | アンケート回答の氏名列 |
| `NAME_SUFFIX_PATTERN` | `/_\d+年(\(\d+\))?$/` | 氏名サフィックス除去パターン |
| `DAYS_BEFORE` | `1` | 何日前にリマインドするか |
| `SEND_HOUR` | `20` | 送信時刻（24時間表記） |
| `SUBJECT` | `'【リマインド】明日は旗振り当番です'` | メール件名 |
| `LABEL_NAME` | `'旗振りリマインド'` | Gmailラベル名 |
| `ATTACHMENT_FILENAME` | `'旗振り地点について.pdf'` | 添付ファイル名（末尾一致検索） |

---

## 関数一覧

### メイン処理

| 関数名 | 説明 |
|--------|------|
| `sendReminders()` | メイン処理。明日の担当者を抽出し、メール送信を実行。トリガーから自動実行される。 |

### トリガー管理

| 関数名 | 説明 |
|--------|------|
| `createDailyTrigger()` | 毎日指定時刻に`sendReminders`を実行するトリガーを作成 |
| `deleteDailyTrigger()` | 既存のトリガーを削除し、自動送信を停止 |

### シミュレーション・テスト

| 関数名 | 説明 |
|--------|------|
| `simulateTomorrow()` | 明日の送信をシミュレーション（メール送信なし） |
| `simulateToday()` | 今日の送信をシミュレーション（メール送信なし） |
| `simulateForDate(daysFromToday)` | 指定日のシミュレーション |
| `testSendReminders()` | 今日の担当者に実際にテストメール送信 |

### ヘルパー関数

| 関数名 | 説明 |
|--------|------|
| `colToIndex(colLetter)` | 列文字をインデックスに変換（'A'→0, 'B'→1, 'AA'→26） |
| `getTomorrowAssignments(sheet, targetDate)` | 指定日の担当者リストを取得 |
| `createEmailMap(sheet)` | アンケートから氏名→メールアドレスのマップを作成 |
| `sendReminderEmail(email, assignment, label)` | メール送信＋ラベル付け＋アーカイブ |
| `getAttachmentFile()` | 添付ファイルを取得（末尾一致検索） |
| `getOrCreateLabel(labelName)` | Gmailラベルを取得または作成 |
| `createLogSheet(ss)` | 送信ログシートを作成 |
| `logToSheet(...)` | 送信ログに記録 |
| `isAlreadySent(sheet, targetDate, email)` | 二重送信チェック |
| `formatDate(date)` | 日付をYYYY/MM/DD形式にフォーマット |
| `isSameDate(date1, date2)` | 日付の一致判定 |
| `stripNameSuffix(name)` | 氏名からサフィックス（_2年など）を除去 |
| `normalizeString(str)` | 文字列正規化（空白除去、全角→半角） |

---

## 処理フロー

### 1. 毎日の自動実行（sendReminders）

```
1. シートを取得（シフト結果、アンケート回答、送信ログ）
2. 明日の日付を計算
3. シフト結果から明日の担当者を抽出
   - ヘッダー行から地点名を自動検出
   - 各セルの氏名を取得（カンマ区切りで複数人対応）
4. アンケート回答からメールアドレスマップを作成
5. 各担当者について:
   a. 氏名からサフィックスを除去（_2年、_4年(2)など）
   b. 正規化してメールアドレスを照合
   c. 二重送信チェック（送信ログを確認）
   d. メール送信（添付ファイル付き）
   e. ラベル付け＋アーカイブ
   f. 送信ログに記録
```

### 2. 氏名照合ロジック

```
シフト結果の氏名: "佐藤太郎_2年"
        ↓ stripNameSuffix()
      "佐藤太郎"
        ↓ normalizeString()
      "佐藤太郎"（空白除去、全角→半角）
        ↓ emailMap[正規化済み氏名]
      "sato@example.com"
```

### 3. 添付ファイル検索

```
CONFIG.ATTACHMENT_FILENAME = '旗振り地点について.pdf'
        ↓
フォルダ内の全ファイルを走査
        ↓
fileName.endsWith('旗振り地点について.pdf') → マッチ
        ↓
「R7旗振り地点について.pdf」「R8旗振り地点について.pdf」等にマッチ
```

---

## データ形式

### シフト結果シート（横持ち形式）

| 日付 | 曜日 | 正門前 | 交差点A | 交差点B |
|------|------|--------|---------|---------|
| 2026/02/05 | 水 | 田中太郎_2年 | 佐藤花子_3年 | 山田次郎_1年 |
| 2026/02/06 | 木 | 鈴木一郎_4年(2) | 高橋三郎_2年 | |

- 地点列の終了は自動検出（空セルで終了）
- 1セルに複数人可能（カンマまたは読点区切り）

### アンケート回答シート

| タイムスタンプ | メールアドレス | ... | 氏名 |
|---------------|---------------|-----|------|
| 2026/01/15 10:30:00 | tanaka@example.com | ... | 田中太郎 |
| 2026/01/15 11:45:00 | sato@example.com | ... | 佐藤花子 |

### 送信ログシート（自動作成）

| 送信日時 | 対象日付 | 氏名 | 場所 | メールアドレス | ステータス |
|----------|----------|------|------|---------------|-----------|
| 2026/02/04 20:00:15 | 2026/02/05 | 田中太郎 | 正門前 | tanaka@example.com | 送信成功 |

---

## 送信メール形式

```
件名: 【リマインド】明日は旗振り当番です

本文:
{氏名} 様

明日は旗振り当番の日です。

━━━━━━━━━━━━━━━━━━━━━━
📅 日付: {YYYY/MM/DD}
📍 場所: {地点名}
━━━━━━━━━━━━━━━━━━━━━━

お忙しいところ恐れ入りますが、
ご対応のほどよろしくお願いいたします。

※このメールは自動送信されています。
※ご都合が悪くなった場合は、PTA担当者までご連絡ください。

--
PTA旗振りシフト管理システム

添付: R*旗振り地点について.pdf（存在する場合）
```

---

## 必要な権限

スクリプト初回実行時に以下の権限承認が必要：

- **Gmail**: メール送信、ラベル管理
- **Googleスプレッドシート**: データ読み取り、ログ書き込み
- **Googleドライブ**: 添付ファイル取得

---

## 運用手順

### 初期設定

1. スプレッドシートを用意し、シートを作成
2. Apps Scriptエディタでスクリプトをコピー
3. `CONFIG`を環境に合わせて編集
4. `simulateTomorrow()`でテスト
5. `createDailyTrigger()`で自動送信開始

### 日常運用

- アンケート回答とシフト結果を定期的に更新
- 送信ログで送信状況を確認

### 自動送信停止

- `deleteDailyTrigger()`を実行

---

## トラブルシューティング

| 問題 | 原因 | 対処 |
|------|------|------|
| メールアドレスが見つからない | 氏名が一致しない | サフィックスパターン確認、空白や全角半角の違い確認 |
| 添付ファイルが付かない | ファイル名不一致 | ファイル名の末尾が設定値と一致するか確認 |
| 二重送信される | 送信ログが消えた | 送信ログシートを確認 |
| トリガーが動かない | 権限エラー | 再度権限承認 |

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-02-04 | 初版作成 |
| | - 横持ち形式対応 |
| | - アルファベット列指定対応 |
| | - 地点列自動検出 |
| | - 氏名サフィックス除去 |
| | - 添付ファイル末尾一致検索 |
| | - シミュレーション機能 |
| | - トリガー削除機能 |
